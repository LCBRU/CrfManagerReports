<crf:areaConfiguration xmlns:crf="http://www.crfmanager.com/system/xml">
  <crf:comment>
    <crf:version>BRC_01</crf:version>
    <crf:analysis>Room Booking</crf:analysis>
    <crf:analysis>Appointments</crf:analysis>
    <crf:analysis></crf:analysis>
    <crf:summary>Room Occupancy by Room, Site and Day os Week</crf:summary>
    <crf:notes>Room Occupancy by Room, Site and Day os Week</crf:notes>
    <crf:InternalNotes>
    </crf:InternalNotes>
  </crf:comment>
  <crf:queryBatch>
    <crf:query name="parameters">
      <crf:searchOptions>
        <crf:parameter name="FirstMonth" type="int" displayName="First Month">
          <crf:query>
            DECLARE @Months TABLE (
              TextField NVARCHAR(20),
              ValueField INT
            )

            DECLARE @date DATE = '20160101'

            WHILE (@date &lt; getdate())
            BEGIN
              INSERT INTO @Months (TextField,ValueField) VALUES (
                FORMAT(@date, 'yyyy MMMM'),
                FORMAT(@date, 'yyyyMMdd')
              );

              SET @date = DATEADD(month, 1, @date)
            END

            SELECT TextField,ValueField FROM @Months;
          </crf:query>
        </crf:parameter>

        <crf:parameter name="LastMonth" type="int" displayName="Last Month">
          <crf:query>
            DECLARE @Months TABLE (
              TextField NVARCHAR(20),
              ValueField INT
            )

            DECLARE @date DATE = '20160101'

            WHILE (@date &lt; getdate())
            BEGIN
              INSERT INTO @Months (TextField,ValueField) VALUES (
                FORMAT(@date, 'yyyy MMMM'),
                FORMAT(@date, 'yyyyMMdd')
              );

              SET @date = DATEADD(month, 1, @date)
            END

            SELECT TextField,ValueField FROM @Months;
          </crf:query>
        </crf:parameter>

        <crf:parameter name="OwnerList" type="nvarchar" displayName="Owning Site" multiSelect="true" initialSelection="All">
          <crf:query>
            SET NOCOUNT ON;

            SELECT
              r.ResourceID AS ValueField,
              r.RName AS TextField
            FROM 	WTCRFResources r
            JOIN 	view_ResourceOptions ro
              ON ro.ResourceID = r.ResourceID
            WHERE 	r.RResourceType = 1016 -- CRF Sites
              AND r.ResourceID IN (
                SELECT ro.ResourceID
                FROM view_ResourceOptions ro
                WHERE ROTValue = 'OWNER'
              )
            ;
          </crf:query>
        </crf:parameter>

      </crf:searchOptions>

      <crf:statement>
        SET NOCOUNT ON;

        DECLARE @StartDate DATE;
        DECLARE @EndDate DATE;
        DECLARE @start_time TIME = '8:30'
        DECLARE @end_time TIME = '16:30'


        SELECT @StartDate = CONVERT(DATE,
          (SELECT WSFValue FROM WTCRFStateFields WHERE WSFName='FirstMonth' AND WSFStateID=@ItemID),
          112)

        SELECT @EndDate = DATEADD(MONTH, 1, CONVERT(DATE,
          (SELECT WSFValue FROM WTCRFStateFields WHERE WSFName='LastMonth' AND WSFStateID=@ItemID),
          112))

        SELECT NULL;

      </crf:statement>
    </crf:query>

    <crf:query name="owners">
      <crf:statement>
        SET NOCOUNT ON;

        DECLARE @OwnerList NVARCHAR(MAX);

        CREATE TABLE #owners(
          id UNIQUEIDENTIFIER NOT NULL PRIMARY KEY,
          name NVARCHAR(100)
        );

        SELECT @OwnerList = WSFValue
        FROM WTCRFStateFields
        WHERE WSFName='OwnerList'
          AND WSFStateID=@ItemID;
        
        INSERT INTO #owners(id, name)
        SELECT o.ItemID, r.RName
        FROM dbo.get_UniqueIdentifierTable(@OwnerList) o
        JOIN WTCRFResources r ON
          r.ResourceID = o.ItemID
        ;

        SELECT NULL;
      </crf:statement>
    </crf:query>

    <crf:query name="resources">
      <crf:statement>
        SET NOCOUNT ON;

        CREATE TABLE #resources(
          id UNIQUEIDENTIFIER NOT NULL PRIMARY KEY,
          name NVARCHAR(100),
          ignore BIT NOT NULL,
          constant_use BIT NOT NULL,
          owner_id UNIQUEIDENTIFIER NOT NULL
        );

        INSERT INTO #resources(id, name, owner_id, ignore, constant_use)
        SELECT
            r.ResourceID,
            r.ResourceName,
            r.ROwnerID,
            CASE
              WHEN r.ResourceID IN (
                '7675426f-ea5a-4617-aeef-8f04f459bafd',
                'a91cfb78-5ccb-402c-a4a7-ca66de9719fa',
                '73918fb7-9ea9-4a57-84de-2b0e3d11ba30',
                'e7823093-2492-4a12-a276-a76e45169d5c',
                'f1c8222e-b252-4575-9b94-394c211a9fdb'
                ) THEN 1
              ELSE 0
            END,
            CASE
              WHEN r.ResourceID IN (
                'aff6535b-39cd-411b-82da-bcbf33a0cf05',
                '37e28095-c80d-4627-8c53-0e549ce1b7dd',
                '342fd606-5150-4efb-95f8-f7e16c220f71'
              ) THEN 1
              ELSE 0
            END
        FROM view_Resources r
        INNER JOIN #owners o
          ON o.id = r.ROwnerID
        WHERE r.ResourceTypeID IN (1010, 1018)
            AND (r.ResourceName NOT LIKE '%outreach%')
            AND (r.ResourceName NOT LIKE '%sample%')
        ;

        UPDATE #resources
        SET name = name + ' (ignored)'
        WHERE ignore = 1;

        UPDATE #resources
        SET name = name + ' (constant use)'
        WHERE constant_use = 1;

        SELECT NULL;
      </crf:statement>
    </crf:query>

    <crf:query name="resource_dates">
      <crf:statement>
        SET NOCOUNT ON;

        CREATE TABLE #resource_dates(
          resource_id UNIQUEIDENTIFIER NOT NULL,
          today DATE NOT NULL,
          tomorrow DATE NOT NULL,
          day_name NVARCHAR(50) NOT NULL,
          day_number INT NOT NULL,
          is_weekend BIT NOT NULL,
          core_start_date_time DATETIME NULL,
          core_end_date_time DATETIME NULL,
          core_minutes INT NOT NULL
        );

        CREATE CLUSTERED INDEX #idx_resource_dates ON #resource_dates(resource_id, today);

        ;WITH seq(n) AS 
        (
          SELECT 0 UNION ALL SELECT n + 1 FROM seq
          WHERE n &lt; (DATEDIFF(DAY, @StartDate, @EndDate) - 1)
        ), d(d) AS
        (
          SELECT DATEADD(DAY, n, @StartDate)
          FROM seq
        ), date_details(today, tomorrow, day_name, day_number, is_weekend, core_start_date_time, core_end_date_time) AS
        (
          SELECT
            d AS today,
            DATEADD(DAY, 1, d) tomorrow,
            DATENAME(weekday, d) day_name,
            DATEPART(weekday, d) day_number,
            CASE WHEN DATEPART(WEEKDAY, d) IN (1, 7) THEN 1 ELSE 0 END is_weekend,
            CAST(d AS DATETIME) + CAST(@start_time AS DATETIME) core_start_date_time,
            CAST(d AS DATETIME) + CAST(@end_time AS DATETIME) core_end_date_time
          FROM d
        )

        INSERT INTO #resource_dates (resource_id, today, tomorrow, day_name, day_number, is_weekend, core_start_date_time, core_end_date_time, core_minutes)
        SELECT
          r.id,
          dd.today,
          dd.tomorrow,
          dd.day_name,
          dd.day_number,
          dd.is_weekend,
          dd.core_start_date_time,
          dd.core_end_date_time,
          DATEDIFF(MINUTE, dd.core_start_date_time, dd.core_end_date_time) core_minutes
        FROM date_details dd
        CROSS JOIN #resources r
        WHERE is_weekend = 0

        UNION

        SELECT
          r.id,
          dd.today,
          dd.tomorrow,
          dd.day_name,
          dd.day_number,
          dd.is_weekend,
          NULL,
          NULL,
          0
        FROM date_details dd
        CROSS JOIN #resources r
        WHERE is_weekend = 1

        OPTION (MAXRECURSION 0);

        SELECT NULL;
      </crf:statement>
    </crf:query>

    <crf:query name="merge_events_to_periods">
      <crf:statement>
        SET NOCOUNT ON;

        CREATE TABLE #merging_events (
          id INT IDENTITY(1,1) NOT NULL,
          resource_id NVARCHAR(50) NOT NULL,
          start_date_time DATETIME2(7) NOT NULL,
          end_date_time DATETIME2(7) NOT NULL,
          merged_min_id NVARCHAR(50) NULL,
        );

        CREATE NONCLUSTERED INDEX #idx_merging_events_id ON #merging_events(id);
        CREATE NONCLUSTERED INDEX #idx_merging_events ON #merging_events(resource_id, start_date_time, end_date_time);

        INSERT INTO #merging_events (resource_id, start_date_time, end_date_time)
        SELECT
          re.ResourceID,
          re.TStartDate,
          re.TEndDate
        FROM view_ResourceEvents re
        JOIN #owners o
          ON o.id = re.ROwnerID
        WHERE re.REStatusID NOT IN (
            5871, -- Cancelled
            5869 -- Unused
          )
          AND re.TStartDate &lt; @EndDate
          AND re.TEndDate &gt; @StartDate
        ;

        UPDATE #merging_events SET merged_min_id = id;

        CREATE TABLE #to_update (
          id INT NOT NULL,
          merged_min_id INT NOT NULL
        );

        DECLARE @todo INT;
        SET @todo = 1
        DECLARE @iterations INT;
        SET @iterations = 0

        WHILE (@todo &gt; 0 AND @iterations &lt; 20)
        BEGIN
          TRUNCATE TABLE #to_update;

          INSERT INTO #to_update (id, merged_min_id)
          SELECT a2.id, MIN(a1.merged_min_id)
          FROM #merging_events a1
          JOIN #merging_events a2
            ON a2.resource_id = a1.resource_id
            AND a2.start_date_time &lt;= a1.end_date_time
            AND a2.end_date_time &gt;= a1.start_date_time
            AND a2.merged_min_id &gt; a1.merged_min_id
          GROUP BY a2.id
          ;

          CREATE NONCLUSTERED INDEX #idx_to_update ON #to_update(id);

          UPDATE a
          SET a.merged_min_id = u.merged_min_id
          FROM #merging_events a
          JOIN #to_update u
            ON u.id = a.id
          ;

          SELECT @todo = COUNT(*) FROM #to_update;

          DROP INDEX #idx_to_update ON #to_update;

          SET @iterations = @iterations + 1

        END

        CREATE TABLE #periods(
          id INT IDENTITY(1,1) NOT NULL,
          merged_min_id INT NOT NULL,
          resource_id NVARCHAR(50) NOT NULL,
          start_date_time DATETIME2(7) NOT NULL,
          end_date_time DATETIME2(7) NOT NULL,
          start_date DATE NOT NULL,
          end_date DATE NOT NULL,
          records_mrged INT NOT NULL
        );

        INSERT INTO #periods (merged_min_id, resource_id, [start_date_time], [end_date_time], [start_date], [end_date], records_mrged)
        SELECT
          merged_min_id,
          resource_id,
          MIN(start_date_time) AS start_date_time,
          
          MAX(end_date_time) AS end_date_time,
          CONVERT(DATE, MIN(start_date_time)) AS start_date,
          CONVERT(DATE, MAX(end_date_time)) AS end_date,
          COUNT(*)
        FROM #merging_events
        GROUP BY resource_id, merged_min_id
        ;

        CREATE NONCLUSTERED INDEX #IX_periods ON #periods(resource_id ASC);

        DROP TABLE #merging_events;
        DROP TABLE #to_update;

        SELECT NULL;
      </crf:statement>
    </crf:query>

    <crf:query name="resource_day_minutes">
      <crf:statement>
        SET NOCOUNT ON;

        CREATE TABLE #resource_day_minutes(
          date DATE NOT NULL,
          resource_id NVARCHAR(50) NOT NULL,
          ooh_minutes INT NOT NULL,
          in_hours_minutes INT NOT NULL
        );

        WITH period_days AS (
          SELECT
            d.resource_id,
            d.today date,
            IIF(d.today &gt; op.start_date_time, d.today, op.start_date_time) start_date_time,
            IIF(d.tomorrow &lt; op.end_date_time, d.tomorrow, op.end_date_time) end_date_time
          FROM #resource_dates d
          LEFT JOIN #periods op
            ON d.today &gt;= op.start_date
            AND d.today &lt;= op.end_date
            AND d.resource_id = op.resource_id
        ), period_days_minutes AS (

          SELECT
            d.resource_id,
            d.today as date,
            pd.start_date_time AS start_date_time,
            d.core_start_date_time AS end_date_time,
            1 AS out_of_hours,
            DATEDIFF(MINUTE, pd.start_date_time, d.core_start_date_time) AS minutes
          FROM #resource_dates d
          LEFT JOIN period_days pd
            ON d.today = pd.date
            AND d.resource_id = pd.resource_id
          WHERE pd.start_date_time &lt; d.core_start_date_time

          UNION

          SELECT
            d.resource_id,
            d.today as date,
            d.core_end_date_time AS start_date_time,
            pd.end_date_time AS end_date_time,
            1 AS out_of_hours,
            DATEDIFF(MINUTE, d.core_end_date_time, pd.end_date_time) AS minutes
          FROM #resource_dates d
          LEFT JOIN period_days pd
            ON d.today = pd.date
            AND d.resource_id = pd.resource_id
          WHERE pd.end_date_time &gt; d.core_end_date_time

          UNION

          SELECT
            resource_id,
            [date],
            start_date_time,
            end_date_time,
            0 AS out_of_hours,
            DATEDIFF(MINUTE, start_date_time, end_date_time) AS minutes
          FROM (
            SELECT
              d.resource_id,
              d.today as date,
              IIF(pd.start_date_time &gt; d.core_start_date_time, pd.start_date_time, d.core_start_date_time) AS start_date_time,
              IIF(pd.end_date_time &lt; d.core_end_date_time, pd.end_date_time, d.core_end_date_time) AS end_date_time
            FROM #resource_dates d
            LEFT JOIN period_days pd
              ON d.today = pd.date
              AND d.resource_id = pd.resource_id
            WHERE pd.start_date_time &lt; d.core_end_date_time
              AND pd.end_date_time &gt; d.core_start_date_time
            ) x
          
        )

        INSERT INTO #resource_day_minutes(
          date,
          resource_id,
          ooh_minutes,
          in_hours_minutes
        )
        SELECT
          p.[date],
          p.resource_id,
          SUM(COALESCE(p.ooh, 0)),
          SUM(COALESCE(p.in_hours, 0))
        FROM (
          SELECT
            pdm.date,
            pdm.resource_id,
            CASE
              WHEN pdm.out_of_hours = 1 THEN 'ooh'
              ELSE 'in_hours'
            END category,
            minutes minutes
          FROM period_days_minutes pdm

        ) x
        PIVOT (
          SUM(minutes)
          FOR category IN (ooh, in_hours)  
        ) p
        GROUP BY p.[date],
          p.resource_id
        ;

        SELECT NULL;

      </crf:statement>
    </crf:query>

    <crf:query name="resource_day_effective">
      <crf:statement>
        SET NOCOUNT ON;

        CREATE TABLE #resource_day_effective (
          date DATE NOT NULL,
          resource_id NVARCHAR(50) NOT NULL,
          resource_name NVARCHAR(100) NOT NULL,
          site_name NVARCHAR(100) NOT NULL,
          month_name NVARCHAR(50) NOT NULL,
          month_number INT NOT NULL,
          day_name NVARCHAR(50) NOT NULL,
          day_number INT NOT NULL,
          ooh_minutes INT NOT NULL,
          in_hours_minutes INT NOT NULL,
          core_minutes INT NOT NULL,
          ooh_minutes_effective INT NOT NULL,
          in_hours_minutes_effective INT NOT NULL,
          core_minutes_effective INT NOT NULL
        );

        INSERT INTO #resource_day_effective(
          date,
          resource_id,
          resource_name,
          site_name,
          month_name,
          month_number,
          day_name,
          day_number,
          ooh_minutes,
          in_hours_minutes,
          core_minutes,
          ooh_minutes_effective,
          in_hours_minutes_effective,
          core_minutes_effective
        )
        SELECT
          rd.today,
          rd.resource_id,
          r.name,
          o.name,
          FORMAT(rd.today, 'yyyy MMMM'),
          FORMAT(rd.today, 'yyyyMM'),
          rd.day_name,
          rd.day_number,
          COALESCE(rdm.ooh_minutes, 0),
          COALESCE(rdm.in_hours_minutes, 0),
          COALESCE(rd.core_minutes, 0),
          COALESCE(
            CASE
              WHEN r.ignore = 1 THEN 0
              WHEN r.constant_use = 1 THEN 0
              ELSE rdm.ooh_minutes
            END , 0),
          COALESCE(
            CASE
              WHEN r.ignore = 1 THEN 0
              WHEN r.constant_use = 1 THEN rd.core_minutes
              ELSE rdm.in_hours_minutes
            END , 0),
          CASE
            WHEN r.ignore = 1 THEN 0
            ELSE rd.core_minutes
          END
        FROM #resource_dates rd
        JOIN #resources r
          ON r.id = rd.resource_id
        JOIN #owners o
          ON o.id = r.owner_id
        LEFT JOIN #resource_day_minutes rdm
          ON rdm.resource_id = rd.resource_id
          AND rdm.date = rd.today

        SELECT NULL;

      </crf:statement>
    </crf:query>

    <crf:query name="site_totals">
      <crf:statement>
        SET NOCOUNT ON;

        SELECT
          site_name,
          SUM(in_hours_minutes_effective) / 60.0 AS in_hours_minutes_effective,
          SUM(ooh_minutes_effective) / 60.0 AS ooh_minutes_effective,
          SUM(core_minutes_effective) / 60.0 AS core_minutes_effective,
          CASE WHEN (SUM(core_minutes_effective) > 0) THEN
            (SUM(in_hours_minutes_effective) * 1.0) / SUM(core_minutes_effective)
          ELSE
            NULL
          END occupancy_percentage_effective
        FROM #resource_day_effective
        GROUP BY site_name
        ;

      </crf:statement>
    </crf:query>

    <crf:query name="month_totals">
      <crf:statement>
        SET NOCOUNT ON;

        SELECT
          site_name,
          month_name,
          SUM(in_hours_minutes_effective) / 60.0 AS in_hours_minutes_effective,
          SUM(ooh_minutes_effective) / 60.0 AS ooh_minutes_effective,
          SUM(core_minutes_effective) / 60.0 AS core_minutes_effective,
          CASE WHEN (SUM(core_minutes_effective) > 0) THEN
            (SUM(in_hours_minutes_effective) * 1.0) / SUM(core_minutes_effective)
          ELSE
            NULL
          END occupancy_percentage_effective
        FROM #resource_day_effective
        GROUP BY site_name, month_name, month_number
        ORDER BY site_name, month_number
        ;

      </crf:statement>
    </crf:query>

    <crf:query name="resource_totals">
      <crf:statement>
        SET NOCOUNT ON;

        SELECT
          site_name,
          resource_name,
          SUM(in_hours_minutes) / 60.0 AS in_hours_minutes,
          SUM(ooh_minutes) / 60.0 AS ooh_minutes,
          SUM(core_minutes) / 60.0 AS core_minutes,
          CASE WHEN (SUM(core_minutes) > 0) THEN
            (SUM(in_hours_minutes) * 1.0) / SUM(core_minutes)
          ELSE
            NULL
          END occupancy_percentage,
          SUM(in_hours_minutes_effective) / 60.0 AS in_hours_minutes_effective,
          SUM(ooh_minutes_effective) / 60.0 AS ooh_minutes_effective,
          SUM(core_minutes_effective) / 60.0 AS core_minutes_effective,
          CASE WHEN (SUM(core_minutes_effective) > 0) THEN
            (SUM(in_hours_minutes_effective) * 1.0) / SUM(core_minutes_effective)
          ELSE
            NULL
          END occupancy_percentage_effective
        FROM #resource_day_effective
        GROUP BY site_name, resource_name
        ORDER BY site_name, resource_name
        ;

      </crf:statement>
    </crf:query>

    <crf:query name="day_totals">
      <crf:statement>
        SET NOCOUNT ON;

        SELECT
          site_name,
          day_name,
          SUM(in_hours_minutes_effective) / 60.0 AS in_hours_minutes_effective,
          SUM(ooh_minutes_effective) / 60.0 AS ooh_minutes_effective,
          SUM(core_minutes_effective) / 60.0 AS core_minutes_effective,
          CASE WHEN (SUM(core_minutes_effective) > 0) THEN
            (SUM(in_hours_minutes_effective) * 1.0) / SUM(core_minutes_effective)
          ELSE
            NULL
          END occupancy_percentage_effective
        FROM #resource_day_effective
        GROUP BY site_name, day_name, day_number
        ORDER BY site_name, day_number
        ;

      </crf:statement>
    </crf:query>

  </crf:queryBatch>

  <crf:body id="1" title="Print format" format="text/xml">
    <xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:crf-utils="crf:utilities" version="1.0">
      <xsl:output method="html" indent="yes" omit-xml-declaration="yes" />
      <xsl:template match="NewDataSet">
        <div>

          <h2>Site Totals</h2>

          <table class="grid" cellpadding="3" cellspacing="0">
            <thead>
              <td>Site Name</td>
              <td>In Hours (h)</td>
              <td>Out of Hours (h)</td>
              <td>Core Hours (h)</td>
              <td>Occupancy (%)</td>
            </thead>
            <tbody>
              <xsl:apply-templates select="site_totals" />
            </tbody>
          </table>

          <h2>Month Totals</h2>

          <table class="grid" cellpadding="3" cellspacing="0">
            <thead>
              <td>Month</td>
              <td>In Hours (h)</td>
              <td>Out of Hours (h)</td>
              <td>Core Hours (h)</td>
              <td>Occupancy (%)</td>
            </thead>
            <tbody>
              <xsl:apply-templates select="month_totals" />
            </tbody>
          </table>

          <h2>Days of the Week</h2>

          <table class="grid" cellpadding="3" cellspacing="0">
            <thead>
              <td>Day of Week</td>
              <td>In Hours (h)</td>
              <td>Out of Hours (h)</td>
              <td>Core Hours (h)</td>
              <td>Occupancy (%)</td>
            </thead>
            <tbody>
              <xsl:apply-templates select="day_totals" />
            </tbody>
          </table>

<<<<<<< HEAD:minimal.xml
          <!-- <h2>Days</h2>
=======
          <h2>Rooms</h2>
>>>>>>> 483a8be (Final version):room_occupancy.xml

          <table class="grid" cellpadding="3" cellspacing="0">
            <thead>
              <td>Room Name</td>
              <td>In Hours (h)</td>
              <td>Out of Hours (h)</td>
              <td>Core Hours (h)</td>
              <td>Occupancy (%)</td>
              <td>In Hours Effective (h)</td>
              <td>Out of Hours Effective (h)</td>
              <td>Core Hours Effective(h)</td>
              <td>Occupancy Effective(%)</td>
            </thead>
            <tbody>
              <xsl:apply-templates select="resource_totals" />
            </tbody>
          </table>
 -->
        </div>
      </xsl:template>

      <xsl:template match="site_totals">
        <tr>
          <td><xsl:value-of select="site_name" /></td>
          <td><xsl:value-of select="format-number(in_hours_minutes_effective, '0.00')" /></td>
          <td><xsl:value-of select="format-number(ooh_minutes_effective, '0.00')" /></td>
          <td><xsl:value-of select="format-number(core_minutes_effective, '0.00')" /></td>
          <td class="section_head">
            <xsl:if test="(occupancy_percentage_effective=occupancy_percentage_effective)">
              <xsl:value-of select="format-number(occupancy_percentage_effective, '0.00%')" />
            </xsl:if>
          </td>
        </tr>
      </xsl:template>

      <xsl:template match="month_totals">
        <xsl:if test="preceding-sibling::month_totals[1]/site_name!=site_name or position()=1">
          <tr>
            <td colspan="5" class="section_head">
              <xsl:value-of select="site_name" />
            </td>
          </tr>
        </xsl:if>
        <tr>
          <td><xsl:value-of select="month_name" /></td>
          <td><xsl:value-of select="format-number(in_hours_minutes_effective, '0.00')" /></td>
          <td><xsl:value-of select="format-number(ooh_minutes_effective, '0.00')" /></td>
          <td><xsl:value-of select="format-number(core_minutes_effective, '0.00')" /></td>
          <td class="section_head">
            <xsl:if test="(occupancy_percentage_effective=occupancy_percentage_effective)">
              <xsl:value-of select="format-number(occupancy_percentage_effective, '0.00%')" />
            </xsl:if>
          </td>
        </tr>
      </xsl:template>

      <xsl:template match="resource_totals">
        <xsl:if test="preceding-sibling::resource_totals[1]/site_name!=site_name or position()=1">
          <tr>
            <td colspan="10" class="section_head">
              <xsl:value-of select="site_name" />
            </td>
          </tr>
        </xsl:if>
        <tr>
          <td><xsl:value-of select="resource_name" /></td>
          <td><xsl:value-of select="format-number(in_hours_minutes, '0.00')" /></td>
          <td><xsl:value-of select="format-number(ooh_minutes, '0.00')" /></td>
          <td><xsl:value-of select="format-number(core_minutes, '0.00')" /></td>
          <td class="section_head">
            <xsl:if test="(occupancy_percentage=occupancy_percentage)">
              <xsl:value-of select="format-number(occupancy_percentage, '0.00%')" />
            </xsl:if>
          </td>
          <td><xsl:value-of select="format-number(in_hours_minutes_effective, '0.00')" /></td>
          <td><xsl:value-of select="format-number(ooh_minutes_effective, '0.00')" /></td>
          <td><xsl:value-of select="format-number(core_minutes_effective, '0.00')" /></td>
          <td class="section_head">
            <xsl:if test="(occupancy_percentage_effective=occupancy_percentage_effective)">
              <xsl:value-of select="format-number(occupancy_percentage_effective, '0.00%')" />
            </xsl:if>
          </td>
        </tr>
      </xsl:template>

      <xsl:template match="day_totals">
        <xsl:if test="preceding-sibling::day_totals[1]/site_name!=site_name or position()=1">
          <tr>
            <td colspan="5" class="section_head">
              <xsl:value-of select="site_name" />
            </td>
          </tr>
        </xsl:if>
        <tr>
          <td><xsl:value-of select="day_name" /></td>
          <td><xsl:value-of select="format-number(in_hours_minutes_effective, '0.00')" /></td>
          <td><xsl:value-of select="format-number(ooh_minutes_effective, '0.00')" /></td>
          <td><xsl:value-of select="format-number(core_minutes_effective, '0.00')" /></td>
          <td class="section_head">
            <xsl:if test="(occupancy_percentage_effective=occupancy_percentage_effective)">
              <xsl:value-of select="format-number(occupancy_percentage_effective, '0.00%')" />
            </xsl:if>
          </td>
        </tr>
      </xsl:template>

    </xsl:stylesheet>
  </crf:body>
</crf:areaConfiguration>